<div class="modal-overlay">
  <div id="modal-add-city" class="flex-column">
    <i class="bi bi-x-lg close"></i>

    <h3>Nueva Campaña</h3>

    <input
      id="city-name"
      type="text"
      placeholder="NOMBRE DE LA CIUDAD"
      required
    />
    <input id="start-date" type="date" required />

    <hr />

    <div id="duplas-container" class="flex-column">
      <!-- Las 2 duplas fijas se generarán aquí -->
    </div>

    <hr />

    <div class="buttons flex-row">
      <button class="boton save-campaign">Guardar</button>
      <button class="boton2 cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- Estilos del modal -->
<style>
  #modal-add-city {
    background-color: var(--clr-dark);
    padding: 20px;
    border: solid 1px var(--clr-border);
    width: 600px;
    max-width: 90%;
    position: relative;
    gap: 10px;
    align-items: flex-start;
    justify-content: flex-start;
    max-height: 88vh;
    overflow-y: auto;
    scroll-behavior: smooth;
  }

  #modal-add-city h3 {
    width: 100%;
    text-align: center;
    color: var(--clr-main);
    margin-bottom: 10px;
    text-transform: uppercase;
  }

  #modal-add-city .close {
    position: fixed;
    top: 20px;
    right: 20px;
    font-size: 20px;
    cursor: pointer;
    border: solid 1px var(--clr-border);
    background-color: var(--clr-dark);
    padding: 7px;
    z-index: 100;
    transition: var(--transition);
  }

  #modal-add-city input {
    width: 100%;
    text-transform: uppercase;
  }

  #duplas-container {
    width: 100%;
    gap: 15px;
  }

  .buttons {
    gap: 5px;
    width: 100%;
  }

  @media (hover: hover) {
    #modal-add-city .close:hover {
      background-color: var(--clr-border);
    }
  }
</style>

<!-- Estilos dinámicos de duplas -->
<style is:inline>
  .dupla-block {
    width: 100%;
    background-color: var(--clr-dark2);
    padding: 15px;
    gap: 10px;
    position: relative;
  }

  .dupla-block > h6 {
    width: fit-content;
    color: var(--clr-main);
    font-size: 0.85rem;
    text-align: center;
    align-self: flex-start;
    font-weight: 600;
  }

  .dupla-content {
    width: 100%;
    display: flex;
    flex-direction: row;
    gap: 5px;
  }

  .dupla-content .bloque-item {
    flex: 1;
    background-color: var(--clr-dark);
    padding: 0px;
    gap: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }

  .bloque-item label {
    width: 100%;
    height: 100%;
    gap: 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .bloque-item input[type="file"] {
    display: none;
  }

  .bloque-item label .bi-upload {
    font-size: 2rem;
    color: var(--clr-text);
  }

  .bloque-item textarea {
    width: 100%;
    min-height: 120px;
    max-height: 120px;
  }
</style>

<script>
  //@ts-nocheck

  // Referencias DOM
  const $closeModal = document.querySelector("#modal-add-city .close");
  const $modalOverlay = document.querySelector(".modal-overlay");
  const $cancelButton = document.querySelector("#modal-add-city .cancel");
  const $saveButton = document.querySelector(".save-campaign");
  const $duplasContainer = document.getElementById("duplas-container");
  const $cityNameInput = document.getElementById("city-name");
  const $startDateInput = document.getElementById("start-date");

  // Nombres fijos de las duplas
  const DUPLA_NAMES = ["INFO", "LUGAR"];

  // Event Listeners
  $closeModal?.addEventListener("click", closeModal);
  $cancelButton?.addEventListener("click", closeModal);
  $saveButton?.addEventListener("click", saveCampaign);

  // Funciones
  function closeModal() {
    $modalOverlay.style.display = "none";
    resetForm();
  }

  function createDuplas() {
    $duplasContainer.innerHTML = "";

    DUPLA_NAMES.forEach((name, index) => {
      const duplaNumber = index + 1;
      const duplaBlock = document.createElement("div");
      duplaBlock.className = "dupla-block flex-column";
      duplaBlock.dataset.duplaName = name;

      duplaBlock.innerHTML = `
        <h6>DUPLA #${duplaNumber}: ${name}</h6>
        
        <div class="dupla-content">
          <div class="bloque-item">
            <label class="pointer">
              <i class="bi bi-upload"></i>
              <input type="file" class="dupla-img" accept="image/*" required />
            </label>
          </div>
          
          <div class="bloque-item">
            <label>
              <textarea class="dupla-text" placeholder="Escribe el texto aquí..." required></textarea>
            </label>
          </div>
        </div>
      `;

      $duplasContainer.appendChild(duplaBlock);
    });
  }

  async function saveCampaign() {
    const cityName = $cityNameInput.value.trim();
    const startDate = $startDateInput.value;

    if (!cityName) {
      alert("Por favor ingresa el nombre de la ciudad");
      return;
    }

    if (!startDate) {
      alert("Por favor selecciona la fecha de inicio");
      return;
    }

    const duplas = [];
    const duplaBlocks = $duplasContainer.querySelectorAll(".dupla-block");

    for (const block of duplaBlocks) {
      const imgInput = block.querySelector(".dupla-img");
      const textInput = block.querySelector(".dupla-text");
      const duplaName = block.dataset.duplaName;

      if (!imgInput.files[0]) {
        alert("Por favor selecciona todas las imágenes");
        return;
      }

      if (!textInput.value.trim()) {
        alert("Por favor completa todos los textos");
        return;
      }

      const imgBase64 = await fileToBase64(imgInput.files[0]);

      duplas.push({
        name: duplaName,
        image: imgBase64,
        text: textInput.value.trim(),
      });
    }

    const campaign = {
      id: Date.now(),
      cityName,
      startDate,
      duplas,
      createdAt: new Date().toISOString(),
    };

    const campaigns = JSON.parse(localStorage.getItem("campaigns") || "[]");
    campaigns.push(campaign);
    localStorage.setItem("campaigns", JSON.stringify(campaigns));

    window.dispatchEvent(
      new CustomEvent("campaignAdded", { detail: campaign }),
    );

    closeModal();
  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function resetForm() {
    $cityNameInput.value = "";
    $startDateInput.value = "";
    createDuplas();
  }

  window.addEventListener("initializeDuplas", () => {
    if ($duplasContainer.children.length === 0) {
      createDuplas();
    }
  });
</script>

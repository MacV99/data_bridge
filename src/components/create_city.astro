<div class="modal-overlay">
  <div id="modal-add-city" class="flex-column">
    <i class="bi bi-x-lg close"></i>

    <h3>Nueva Campaña</h3>

    <input
      id="city-name"
      type="text"
      placeholder="NOMBRE DE LA CIUDAD"
      required
    />
    <input id="start-date" type="date" required />

    <hr />

    <div id="duplas-container" class="flex-column">
      <!-- Las duplas se generarán dinámicamente aquí -->
    </div>

    <button class="boton add-dupla">Añadir Dupla</button>

    <hr />

    <div class="buttons flex-row">
      <button class="boton save-campaign">Guardar</button>
      <button class="boton2 cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- ESTILOS ESTÁTICOS - Elementos que existen en el HTML -->
<style>
  #modal-add-city {
    background-color: var(--clr-dark);
    padding: 20px;
    border: solid 1px var(--clr-border);
    width: 600px;
    max-width: 90%;
    position: relative;
    gap: 10px;
    align-items: flex-start;
    max-height: 85%;
    overflow-y: auto;
  }

  #modal-add-city h3 {
    width: 100%;
    text-align: center;
    color: var(--clr-main);
    margin-bottom: 10px;
    text-transform: uppercase;
  }

  #modal-add-city .close {
    position: fixed;
    top: 20px;
    right: 20px;
    font-size: 20px;
    cursor: pointer;
    border: solid 1px var(--clr-border);
    padding: 7px;
    transition: var(--transition);
    background-color: var(--clr-dark);
    z-index: 100;
  }

  #modal-add-city .close:hover {
    background-color: var(--clr-border);
  }

  #modal-add-city input {
    width: 100%;
  }

  #duplas-container {
    width: 100%;
    gap: 15px;
  }

  .buttons {
    gap: 5px;
    width: 100%;
  }

  .add-dupla {
    gap: 8px;
    width: fit-content;
    align-self: center;
  }
</style>

<!-- ESTILOS DINÁMICOS - Elementos creados por JavaScript -->
<style is:inline>
  /* Bloque de dupla completo */
  .dupla-block {
    width: 100%;
    background-color: var(--clr-dark2);
    padding: 15px;
    gap: 10px;
    position: relative;
  }

  .dupla-block > h6 {
    width: fit-content;
    color: var(--clr-main);
    font-size: 0.85rem;
    text-align: center;
    margin-bottom: 5px;
    align-self: flex-start;
  }

  /* Botón eliminar dupla */
  .dupla-block .remove-dupla {
    position: absolute;
    top: 10px;
    right: 10px;
    background: transparent;
    border: none;
    color: var(--clr-gray);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0;
    width: auto;
    transition: var(--transition);
  }

  .dupla-block .remove-dupla:hover {
    color: var(--clr-main);
    background: transparent;
  }

  /* Contenedor horizontal (imagen | texto) */
  .dupla-content {
    width: 100%;
    display: flex;
    flex-direction: row;
    gap: 10px;
  }

  /* Cada mitad del bloque */
  .bloque-item {
    flex: 1;
    background-color: var(--clr-dark);
    border: solid 1px var(--clr-gray);
    padding: 10px;
    gap: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }

  .bloque-item h6 {
    width: 100%;
    text-align: left;
    color: var(--clr-text);
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 5px;
  }

  .bloque-item label {
    width: 100%;
    gap: 5px;
    display: flex;
    flex-direction: column;
  }

  .bloque-item input[type="file"] {
    width: 100%;
    font-size: 0.85rem;
    padding: 5px;
  }

  .bloque-item textarea {
    width: 100%;
    min-height: 120px;
    max-height: 120px;
    resize: none;
  }

  /* Responsive */
  @media (max-width: 600px) {
    .dupla-content {
      flex-direction: column;
    }
  }
</style>

<script>
  //@ts-nocheck

  // Referencias DOM
  const $closeModal = document.querySelector("#modal-add-city .close");
  const $modalOverlay = document.querySelector(".modal-overlay");
  const $cancelButton = document.querySelector("#modal-add-city .cancel");
  const $saveButton = document.querySelector(".save-campaign");
  const $addDuplaButton = document.querySelector(".add-dupla");
  const $duplasContainer = document.getElementById("duplas-container");
  const $cityNameInput = document.getElementById("city-name");
  const $startDateInput = document.getElementById("start-date");

  let duplaCounter = 0;

  // Inicializar con una dupla por defecto
  document.addEventListener("DOMContentLoaded", () => {
    addDupla();
  });

  // Event Listeners
  $closeModal?.addEventListener("click", closeModal);
  $cancelButton?.addEventListener("click", closeModal);
  $addDuplaButton?.addEventListener("click", addDupla);
  $saveButton?.addEventListener("click", saveCampaign);

  // Funciones
  function closeModal() {
    $modalOverlay.style.display = "none";
    resetForm();
  }

  function addDupla() {
    duplaCounter++;
    const duplaBlock = document.createElement("div");
    duplaBlock.className = "dupla-block flex-column";
    duplaBlock.dataset.duplaId = duplaCounter;

    duplaBlock.innerHTML = `
      <h6>DUPLA ${duplaCounter}</h6>
      ${duplaCounter > 1 ? '<i class="bi bi-trash remove-dupla"></i>' : ""}
      
      <div class="dupla-content">
        <div class="bloque-item">
          <h6>IMAGEN ${duplaCounter}</h6>
          <label>
            <input type="file" class="dupla-img" accept="image/*" required />
          </label>
        </div>
        
        <div class="bloque-item">
          <h6>TEXTO ${duplaCounter}</h6>
          <label>
            <textarea class="dupla-text" placeholder="Escribe el texto aquí..." required></textarea>
          </label>
        </div>
      </div>
    `;

    // Event listener para eliminar dupla
    const removeBtn = duplaBlock.querySelector(".remove-dupla");
    if (removeBtn) {
      removeBtn.addEventListener("click", () => {
        duplaBlock.remove();
        updateDuplaNumbers();
      });
    }

    $duplasContainer.appendChild(duplaBlock);
  }

  function updateDuplaNumbers() {
    const duplas = $duplasContainer.querySelectorAll(".dupla-block");
    duplas.forEach((dupla, index) => {
      const number = index + 1;
      dupla.querySelector("h6").textContent = `DUPLA ${number}`;
      dupla.querySelector(".bloque-item:nth-of-type(1) h6").textContent =
        `IMAGEN ${number}`;
      dupla.querySelector(".bloque-item:nth-of-type(2) h6").textContent =
        `TEXTO ${number}`;
    });
  }

  async function saveCampaign() {
    const cityName = $cityNameInput.value.trim();
    const startDate = $startDateInput.value;

    // Validaciones
    if (!cityName) {
      alert("Por favor ingresa el nombre de la ciudad");
      return;
    }

    if (!startDate) {
      alert("Por favor selecciona la fecha de inicio");
      return;
    }

    const duplas = [];
    const duplaBlocks = $duplasContainer.querySelectorAll(".dupla-block");

    for (const block of duplaBlocks) {
      const imgInput = block.querySelector(".dupla-img");
      const textInput = block.querySelector(".dupla-text");

      if (!imgInput.files[0]) {
        alert("Por favor selecciona todas las imágenes");
        return;
      }

      if (!textInput.value.trim()) {
        alert("Por favor completa todos los textos");
        return;
      }

      // Convertir imagen a base64
      const imgBase64 = await fileToBase64(imgInput.files[0]);

      duplas.push({
        image: imgBase64,
        text: textInput.value.trim(),
      });
    }

    // Crear objeto de campaña
    const campaign = {
      id: Date.now(),
      cityName,
      startDate,
      duplas,
      createdAt: new Date().toISOString(),
    };

    // Guardar en localStorage
    const campaigns = JSON.parse(localStorage.getItem("campaigns") || "[]");
    campaigns.push(campaign);
    localStorage.setItem("campaigns", JSON.stringify(campaigns));

    // Disparar evento personalizado para actualizar el dashboard
    window.dispatchEvent(
      new CustomEvent("campaignAdded", { detail: campaign }),
    );

    closeModal();
  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function resetForm() {
    $cityNameInput.value = "";
    $startDateInput.value = "";
    $duplasContainer.innerHTML = "";
    duplaCounter = 0;
    addDupla();
  }
</script>

<div class="modal-overlay" id="modal-campaign-overlay">
  <div id="modal-add-city" class="flex-column">
    <i class="bi bi-x-lg close"></i>

    <h3 id="modal-title">Nueva Campaña</h3>

    <input
      id="city-name"
      type="text"
      placeholder="NOMBRE DE LA CIUDAD"
      required
    />

    <div class="flex-row" style="width: 100%; gap: 5px;">
      <input id="start-date" type="date" required class="form-date" />

      <select id="phone-number" required class="form-select">
        <option value="" disabled selected hidden>NÚMERO</option>
        <option value="DARIO">DARIO: 15558720556</option>
        <option value="CURSOS">CURSOS: 15558432527</option>
      </select>
    </div>

    <hr />

    <div id="duplas-container" class="flex-column"></div>

    <hr />

    <div class="buttons flex-row">
      <button class="boton save-campaign">Guardar</button>
      <button class="boton2 cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal de Confirmación -->
<div class="modal-overlay" id="modal-confirm-overlay">
  <div id="modal-confirm" class="flex-column">
    <i class="bi bi-exclamation-triangle-fill icon-warning"></i>
    <h4 id="confirm-message">¿Estás seguro?</h4>
    <div class="buttons flex-row">
      <button class="boton confirm-yes">Sí</button>
      <button class="boton2 confirm-no">No</button>
    </div>
  </div>
</div>

<!-- Modal de Alerta -->
<div class="modal-overlay" id="modal-alert-overlay">
  <div id="modal-alert" class="flex-column">
    <i class="bi bi-info-circle-fill icon-info"></i>
    <p id="alert-message">Mensaje de alerta</p>
    <button class="boton alert-ok">Entendido</button>
  </div>
</div>

<style>
  /* === MODAL PRINCIPAL (NUEVA/EDITAR CAMPAÑA) === */
  #modal-add-city {
    background-color: var(--clr-dark);
    border: solid 1px var(--clr-border);
    padding: 15px 20px;
    width: 470px;
    max-width: 90%;
    position: relative;
    gap: 5px;
    align-items: flex-start;
    justify-content: flex-start;
    max-height: 88vh;
    overflow-y: auto;
    scroll-behavior: smooth;
  }

  #modal-add-city h3 {
    width: 100%;
    text-align: center;
    color: var(--clr-main);
    margin-bottom: 2px;
    text-transform: uppercase;
  }

  #modal-add-city .close {
    position: fixed;
    top: 20px;
    right: 20px;
    font-size: 20px;
    cursor: pointer;
    border: solid 1px var(--clr-border);
    background-color: var(--clr-dark);
    padding: 7px;
    z-index: 100;
    transition: var(--transition);
  }

  #modal-add-city input,
  #modal-add-city select {
    width: 100%;
    text-transform: uppercase;
  }

  .form-date,
  .form-select {
    font-size: 0.8rem;
  }

  #duplas-container {
    width: 100%;
  }

  .buttons {
    gap: 5px;
    width: 100%;
  }

  @media (hover: hover) {
    #modal-add-city .close:hover {
      background-color: var(--clr-border);
    }
  }

  /* === MODALES DE CONFIRMACIÓN Y ALERTA === */
  #modal-confirm,
  #modal-alert {
    background-color: var(--clr-dark);
    padding: 30px 20px;
    border: solid 1px var(--clr-border);
    width: 400px;
    max-width: 90%;
    gap: 15px;
    text-align: center;
  }

  #modal-confirm h4,
  #modal-alert p {
    color: var(--clr-white);
    font-size: 1rem;
  }

  #modal-confirm .icon-warning {
    font-size: 3rem;
    color: var(--clr-main);
  }

  #modal-alert .icon-info {
    font-size: 3rem;
    color: var(--clr-main);
  }
</style>

<style is:inline>
  /* === BLOQUES DE DUPLAS === */
  .dupla-block {
    width: 100%;
    background-color: var(--clr-dark);
    padding: 7px 10px;
    gap: 7px;
    position: relative;
  }

  .dupla-block > h6 {
    width: fit-content;
    color: var(--clr-main);
    font-size: 0.85rem;
    text-align: center;
    align-self: flex-start;
    font-weight: 600;
  }

  /* === CONTENIDO DE DUPLAS === */
  .dupla-content {
    width: 100%;
    display: flex;
    flex-direction: row;
    gap: 5px;
    justify-content: space-between;
    padding: 0 1px;
  }

  .dupla-content .bloque-item {
    flex: 1;
    background-color: var(--clr-dark);
    padding: 0px;
    gap: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    width: 192px;
    height: 192px;
    flex: 0 0 auto;
  }

  /* === LABELS DE IMAGEN === */
  .bloque-item label.image-label {
    width: 192px;
    height: 192px;
    min-height: 120px;
    gap: 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    background-color: var(--clr-dark2);
    border: solid 1px var(--clr-border);
  }

  .bloque-item input[type="file"] {
    display: none;
  }

  .bloque-item label .bi-upload {
    font-size: 2rem;
    color: var(--clr-text);
  }

  .bloque-item label img.preview {
    width: 192px;
    height: 192px;
    min-height: 120px;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
  }

  .bloque-item label {
    height: 100%;
    width: 100%;
  }

  /* === TEXTAREA === */
  .bloque-item textarea {
    width: 100%;
    height: 100%;
    font-size: 0.8rem;
  }
</style>

<script>
  //@ts-nocheck
  import { createCampaign, updateCampaign } from "../lib/database.js";

  // CONSTANTES Y REFERENCIAS DOM
  const DUPLA_NAMES = ["INFO", "LUGAR"];

  const $closeModal = document.querySelector("#modal-add-city .close");
  const $modalOverlay = document.getElementById("modal-campaign-overlay");
  const $cancelButton = document.querySelector("#modal-add-city .cancel");
  const $saveButton = document.querySelector(".save-campaign");
  const $duplasContainer = document.getElementById("duplas-container");
  const $cityNameInput = document.getElementById("city-name");
  const $startDateInput = document.getElementById("start-date");
  const $phoneNumberSelect = document.getElementById("phone-number");
  const $modalTitle = document.getElementById("modal-title");

  // Modales de confirmación y alerta
  const $confirmOverlay = document.getElementById("modal-confirm-overlay");
  const $confirmMessage = document.getElementById("confirm-message");
  const $confirmYes = document.querySelector(".confirm-yes");
  const $confirmNo = document.querySelector(".confirm-no");

  const $alertOverlay = document.getElementById("modal-alert-overlay");
  const $alertMessage = document.getElementById("alert-message");
  const $alertOk = document.querySelector(".alert-ok");

  let editingCampaignId = null;
  let confirmCallback = null;

  // EVENT LISTENERS

  $closeModal?.addEventListener("click", closeModal);
  $cancelButton?.addEventListener("click", closeModal);
  $saveButton?.addEventListener("click", saveCampaign);
  window.addEventListener("initializeDuplas", initializeDuplasHandler);
  window.addEventListener("editCampaign", handleEditCampaign);

  // Cerrar modales con ESC y click en overlay
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeModal();
      closeConfirmModal();
      closeAlertModal();
    }
  });

  $modalOverlay?.addEventListener("click", (e) => {
    if (e.target === $modalOverlay) closeModal();
  });

  $confirmOverlay?.addEventListener("click", (e) => {
    if (e.target === $confirmOverlay) closeConfirmModal();
  });

  $alertOverlay?.addEventListener("click", (e) => {
    if (e.target === $alertOverlay) closeAlertModal();
  });

  $confirmNo?.addEventListener("click", closeConfirmModal);
  $alertOk?.addEventListener("click", closeAlertModal);

  // FUNCIONES - MODAL PRINCIPAL

  function closeModal() {
    $modalOverlay.style.display = "none";
    resetForm();
  }

  function resetForm() {
    editingCampaignId = null;
    $modalTitle.textContent = "Nueva Campaña";
    $cityNameInput.value = "";
    $startDateInput.value = "";
    $phoneNumberSelect.value = "";
    createDuplas();
  }

  // FUNCIONES - MODAL DE CONFIRMACIÓN
  function showConfirmModal(message, callback) {
    $confirmMessage.textContent = message;
    confirmCallback = callback;
    $confirmOverlay.style.display = "flex";
  }

  function closeConfirmModal() {
    $confirmOverlay.style.display = "none";
    confirmCallback = null;
  }

  $confirmYes?.addEventListener("click", () => {
    if (confirmCallback) confirmCallback();
    closeConfirmModal();
  });

  // FUNCIONES - MODAL DE ALERTA
  function showAlertModal(message) {
    $alertMessage.textContent = message;
    $alertOverlay.style.display = "flex";
  }

  function closeAlertModal() {
    $alertOverlay.style.display = "none";
  }

  // FUNCIONES - DUPLAS
  function createDuplas(existingDuplas = null) {
    $duplasContainer.innerHTML = "";

    DUPLA_NAMES.forEach((name, index) => {
      const duplaNumber = index + 1;
      const duplaBlock = document.createElement("div");
      duplaBlock.className = "dupla-block flex-column";
      duplaBlock.dataset.duplaName = name;

      const existingDupla = existingDuplas?.find((d) => d.name === name);
      const existingText = existingDupla?.text || "";
      const existingImage = existingDupla?.image_url || "";

      duplaBlock.innerHTML = `
        <h6>DUPLA #${duplaNumber}: ${name}${duplaNumber === 2 ? " (OPCIONAL)" : ""}</h6>
        <div class="dupla-content">
          <div class="bloque-item">
            <label class="image-label">
              <i class="bi bi-upload"></i>
              <input type="file" class="dupla-img" accept="image/*" ${duplaNumber === 1 ? "required" : ""} />
            </label>
          </div>
          <div class="bloque-item">
            <label>
              <textarea class="dupla-text" placeholder="Escribe el texto aquí..." ${duplaNumber === 1 ? "required" : ""}>${existingText}</textarea>
            </label>
          </div>
        </div>
      `;

      $duplasContainer.appendChild(duplaBlock);

      // Referencias
      const imgInput = duplaBlock.querySelector(".dupla-img");
      const imgLabel = duplaBlock.querySelector(".image-label");
      const uploadIcon = imgLabel.querySelector(".bi-upload");

      // Si hay imagen existente, mostrarla
      if (existingImage) {
        imgInput.dataset.existingImage = existingImage;
        const previewImg = document.createElement("img");
        previewImg.src = existingImage;
        previewImg.alt = "Preview";
        previewImg.className = "preview";
        imgLabel.appendChild(previewImg);
        uploadIcon.style.display = "none";
      }

      // Event listener para preview de imagen
      imgInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
          // Comprimir imagen antes de mostrar preview
          const compressedBase64 = await compressImage(file);

          // Eliminar preview anterior si existe
          const existingPreview = imgLabel.querySelector(".preview");
          if (existingPreview) {
            existingPreview.remove();
          }

          // Crear nueva imagen preview
          const previewImg = document.createElement("img");
          previewImg.src = compressedBase64;
          previewImg.alt = "Preview";
          previewImg.className = "preview";
          imgLabel.appendChild(previewImg);

          // Ocultar icono de upload
          uploadIcon.style.display = "none";

          // Guardar la imagen comprimida en el dataset
          imgInput.dataset.compressedImage = compressedBase64;

          // Limpiar dataset de imagen existente
          delete imgInput.dataset.existingImage;
        }
      });
    });
  }

  function initializeDuplasHandler() {
    if ($duplasContainer.children.length === 0) {
      createDuplas();
    }
  }

  // FUNCIONES - EDICIÓN DE CAMPAÑA
  function handleEditCampaign(event) {
    const campaign = event.detail;
    editingCampaignId = campaign.id;

    $modalTitle.textContent = "Editar Campaña";
    $cityNameInput.value = campaign.city_name;
    $startDateInput.value = campaign.start_date;
    $phoneNumberSelect.value = campaign.phone_number;

    createDuplas(campaign.duplas);

    $modalOverlay.style.display = "flex";
  }

  // FUNCIONES - GUARDADO Y VALIDACIÓN
  async function saveCampaign() {
    const cityName = normalizeCityName($cityNameInput.value);
    const startDate = $startDateInput.value;
    const phoneNumber = $phoneNumberSelect.value;

    // Validaciones básicas
    if (!cityName) {
      showAlertModal("Por favor ingresa el nombre de la ciudad");
      return;
    }

    if (!startDate) {
      showAlertModal("Por favor selecciona la fecha de inicio");
      return;
    }

    if (!phoneNumber) {
      showAlertModal("Por favor selecciona el número de teléfono");
      return;
    }

    const duplas = [];
    const duplaBlocks = $duplasContainer.querySelectorAll(".dupla-block");

    // Recolectar datos de duplas
    for (let i = 0; i < duplaBlocks.length; i++) {
      const block = duplaBlocks[i];
      const imgInput = block.querySelector(".dupla-img");
      const textInput = block.querySelector(".dupla-text");
      const duplaName = block.dataset.duplaName;
      const isDupla1 = i === 0;

      // Verificar si hay imagen comprimida, archivo nuevo o imagen existente
      const hasCompressedImage = imgInput?.dataset?.compressedImage;
      const hasNewFile = imgInput?.files?.length > 0;
      const hasExistingImage = imgInput?.dataset?.existingImage;
      const hasText = textInput?.value.trim();

      // Validar dupla 1 (obligatoria)
      if (isDupla1) {
        if (!hasCompressedImage && !hasNewFile && !hasExistingImage) {
          showAlertModal("Por favor selecciona la imagen de la DUPLA #1");
          return;
        }

        if (!hasText) {
          showAlertModal("Por favor completa el texto de la DUPLA #1");
          return;
        }
      }

      // Dupla 2 es opcional - solo agregar si tiene contenido
      if (hasCompressedImage || hasNewFile || hasExistingImage || hasText) {
        let imgBase64 = null;

        // Prioridad: imagen comprimida > archivo nuevo > imagen existente
        if (hasCompressedImage) {
          imgBase64 = imgInput.dataset.compressedImage;
        } else if (hasNewFile) {
          imgBase64 = await compressImage(imgInput.files[0]);
        } else if (hasExistingImage) {
          imgBase64 = imgInput.dataset.existingImage;
        } else if (!isDupla1) {
          continue; // Skip dupla 2 si no tiene imagen
        }

        if (imgBase64) {
          duplas.push({
            name: duplaName,
            image: imgBase64,
            text: hasText ? textInput.value.trim() : "",
          });
        }
      }
    }

    // Verificar que al menos dupla 1 exista
    if (duplas.length === 0) {
      showAlertModal("Debes completar al menos la DUPLA #1");
      return;
    }

    // Crear objeto de campaña
    const campaignData = {
      cityName,
      startDate,
      phoneNumber,
      duplas,
    };

    // Deshabilitar botón mientras guarda
    $saveButton.disabled = true;
    $saveButton.innerHTML =
      '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>';

    let success = false;

    if (editingCampaignId) {
      success = await updateCampaign(editingCampaignId, campaignData);
    } else {
      const result = await createCampaign(campaignData);
      success = result !== null;
    }

    // Rehabilitar botón
    $saveButton.disabled = false;
    $saveButton.textContent = "Guardar";

    if (success) {
      // Notificar cambio
      window.dispatchEvent(new CustomEvent("campaignAdded"));
      closeModal();
    } else {
      showAlertModal("Error al guardar la campaña. Intenta nuevamente.");
    }
  }

  // FUNCIONES - UTILIDADES
  function normalizeCityName(name) {
    return name
      .trim()
      .toUpperCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, ""); // Elimina tildes
  }

  /**
   * Comprime una imagen usando Canvas API
   * Redimensiona a máximo 800x800 y comprime a JPEG 70%
   */
  async function compressImage(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();

      reader.onload = (e) => {
        const img = new Image();

        img.onload = () => {
          // Configuración de compresión
          const MAX_WIDTH = 800;
          const MAX_HEIGHT = 800;
          const QUALITY = 0.7; // 70% calidad JPEG

          let width = img.width;
          let height = img.height;

          // Calcular nuevas dimensiones manteniendo aspect ratio
          if (width > height) {
            if (width > MAX_WIDTH) {
              height = Math.round((height * MAX_WIDTH) / width);
              width = MAX_WIDTH;
            }
          } else {
            if (height > MAX_HEIGHT) {
              width = Math.round((width * MAX_HEIGHT) / height);
              height = MAX_HEIGHT;
            }
          }

          // Crear canvas y comprimir
          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          // Convertir a JPEG comprimido
          const compressedBase64 = canvas.toDataURL("image/jpeg", QUALITY);
          resolve(compressedBase64);
        };

        img.onerror = reject;
        img.src = e.target.result;
      };

      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
</script>

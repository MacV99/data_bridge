---
import Layout1 from "../layouts/Layout1.astro";
import Header from "../sections/header.astro";
import CreateCity from "../components/create_city.astro";
---

<Layout1 title="Dashboard">
  <Header />
  <CreateCity />
  <section id="dashboard" class="flex-row">
    <div id="pendiente">
      <h2>PENDIENTES</h2>
      <div></div>
    </div>
    <div id="montada">
      <h2>MONTADAS</h2>
      <div></div>
    </div>
    <!-- Las campañas se renderizan dinámicamente aquí -->
  </section>
</Layout1>

<!-- Estilos del dashboard -->
<style>
  #dashboard {
    padding: 30px;
    flex-wrap: wrap;
    gap: 20px;
    align-items: flex-start;
  }

  .empty-state {
    width: 100%;
    padding: 60px 20px;
    gap: 15px;
    color: var(--clr-gray);
  }

  .empty-state i {
    font-size: 3rem;
  }

  .empty-state h4 {
    color: var(--clr-text);
  }
</style>

<!-- Estilos dinámicos de campañas y bloques -->
<style is:inline>
  .campaign-card {
    background-color: var(--clr-dark2);
    padding: 15px 15px;
    width: 450px;
    max-width: 100%;
    gap: 5px;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    border: solid 1px var(--clr-border);
    text-align: left;
  }

  .campaign-card .delete-campaign,
  .campaign-card .edit-campaign {
    position: absolute;
    top: 15px;
    right: 15px;
    background-color: var(--clr-dark);
    border: solid 1px var(--clr-border);
    color: var(--clr-gray);
    cursor: pointer;
    font-size: 20px;
    padding: 9px;
    transition: var(--transition);
  }

  .campaign-card .edit-campaign {
    right: 57px;
  }

  .campaign-header {
    width: 100%;
    gap: 5px;
    padding-bottom: 5px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .campaign-header h5 {
    color: var(--clr-main);
    font-size: 1.1rem;
    cursor: pointer;
    padding-left: 0;
  }

  .campaign-header p {
    font-size: 0.85rem;
    color: var(--clr-text);
    display: flex;
    gap: 7px;
  }

  .campaign-header p:first-of-type {
    cursor: pointer;
  }

  .bloque {
    padding: 12px;
    width: 100%;
    gap: 10px;
    background-color: var(--clr-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bloque > h6 {
    width: 100%;
    color: var(--clr-main);
    font-size: 0.8rem;
    text-align: left;
    font-weight: 600;
  }

  .bloque-content {
    width: 100%;
    display: flex;
    flex-direction: row;
    gap: 10px;
  }

  .bloque-item {
    flex: 1;
    background-color: var(--clr-dark);
    padding: 0px;
    gap: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bloque-item img {
    width: 192px;
    height: 192px;
    object-fit: cover;
    border: solid 1px var(--clr-border);
  }

  .bloque-item p {
    padding: 8px;
    background-color: var(--clr-dark2);
    border: solid 1px var(--clr-border);
    color: var(--clr-text);
    font-size: 0.85rem;
    line-height: 1.2;
    height: 192px;
    width: 192px;
    overflow: hidden;
    overflow-wrap: break-word;
  }

  .bloque-item button {
    width: 100%;
    font-size: 0.8rem;
    padding: 8px 12px;
    gap: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .bloque-item button i {
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (hover: hover) {
    .campaign-card .delete-campaign:hover,
    .campaign-card .edit-campaign:hover {
      color: var(--clr-main);
    }
  }
</style>

<script>
  //@ts-nocheck

  // ============================================
  // REFERENCIAS DOM
  // ============================================

  const $dashboard = document.getElementById("dashboard");

  // ============================================
  // EVENT LISTENERS
  // ============================================

  document.addEventListener("DOMContentLoaded", () => {
    renderCampaigns();
  });

  window.addEventListener("campaignAdded", () => {
    renderCampaigns();
  });

  // ============================================
  // FUNCIONES - RENDERIZADO
  // ============================================

  function renderCampaigns() {
    const campaigns = JSON.parse(localStorage.getItem("campaigns") || "[]");

    // Estado vacío
    if (campaigns.length === 0) {
      $dashboard.innerHTML = `
        <div class="empty-state flex-column">
          <i class="bi bi-inbox"></i>
          <h4>No hay campañas aún</h4>
          <p>Haz clic en el botón + para crear tu primera campaña</p>
        </div>
      `;
      return;
    }

    // Renderizar campañas
    $dashboard.innerHTML = campaigns
      .map(
        (campaign) => `
      <div class="campaign-card" data-id="${campaign.id}">
        <i class="bi bi-pencil-square edit-campaign" data-id="${campaign.id}"></i>
        <i class="bi bi-trash delete-campaign" data-id="${campaign.id}"></i>
        <div class="campaign-header">
          <h5 data-copy="${campaign.cityName}">${campaign.cityName}</h5>
          <p data-copy="${formatDate(campaign.startDate)}"><i class="bi bi-calendar3"></i> ${formatDate(campaign.startDate)}</p>
          <p><i class="bi bi-telephone-fill"></i> ${campaign.phoneNumber}</p>
        </div>
        ${campaign.duplas
          .map(
            (dupla, index) => `
          <div class="bloque">
            <h6>DUPLA #${index + 1}: ${dupla.name}</h6>
            <div class="bloque-content">
              <div class="bloque-item">
                <img src="${dupla.image}" alt="Imagen ${dupla.name}" />
                <button class="boton download-img" data-img="${dupla.image}" data-name="${getImageFileName(campaign.cityName, index)}">
                  <i class="bi bi-download"></i>
                </button>
              </div>
              <div class="bloque-item">
                <p>${escapeHtml(dupla.text)}</p>
                <button class="boton copy-text" data-text="${escapeHtml(dupla.text)}">
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
            </div>
          </div>
        `,
          )
          .join("")}
      </div>
    `,
      )
      .join("");

    addEventListeners();
  }

  // ============================================
  // FUNCIONES - EVENT LISTENERS DINÁMICOS
  // ============================================

  function addEventListeners() {
    addCopyTextListener();
    addCopyClickListener();
    addDownloadImageListener();
    addDeleteCampaignListener();
    addEditCampaignListener();
  }

  function addCopyTextListener() {
    document.querySelectorAll(".copy-text").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const text = e.currentTarget.dataset.text;
        navigator.clipboard.writeText(text).then(() => {
          const originalText = e.currentTarget.innerHTML;
          e.currentTarget.innerHTML = '<i class="bi bi-check"></i> Copiado!';
          setTimeout(() => {
            e.currentTarget.innerHTML = originalText;
          }, 1500);
        });
      });
    });
  }

  function addCopyClickListener() {
    document.querySelectorAll("[data-copy]").forEach((element) => {
      element.addEventListener("click", (e) => {
        const text = e.currentTarget.dataset.copy;
        navigator.clipboard.writeText(text).then(() => {
          e.currentTarget.style.opacity = "0.7";
          setTimeout(() => {
            e.currentTarget.style.opacity = "1";
          }, 500);
        });
      });
    });
  }

  function addDownloadImageListener() {
    document.querySelectorAll(".download-img").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const imgData = e.currentTarget.dataset.img;
        const fileName = e.currentTarget.dataset.name;
        downloadImage(imgData, fileName);
      });
    });
  }

  function addDeleteCampaignListener() {
    document.querySelectorAll(".delete-campaign").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const id = parseInt(e.currentTarget.dataset.id);
        const $confirmOverlay = document.getElementById(
          "modal-confirm-overlay",
        );
        const $confirmMessage = document.getElementById("confirm-message");
        const $confirmYes = document.querySelector(".confirm-yes");

        $confirmMessage.textContent = "¿Estás seguro de eliminar esta campaña?";
        $confirmOverlay.style.display = "flex";

        const handleConfirm = () => {
          deleteCampaign(id);
          $confirmOverlay.style.display = "none";
          $confirmYes.removeEventListener("click", handleConfirm);
        };

        $confirmYes.addEventListener("click", handleConfirm);
      });
    });
  }

  function addEditCampaignListener() {
    document.querySelectorAll(".edit-campaign").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const id = parseInt(e.currentTarget.dataset.id);
        const campaigns = JSON.parse(localStorage.getItem("campaigns") || "[]");
        const campaign = campaigns.find((c) => c.id === id);

        if (campaign) {
          window.dispatchEvent(
            new CustomEvent("editCampaign", { detail: campaign }),
          );
        }
      });
    });
  }

  // ============================================
  // FUNCIONES - ACCIONES
  // ============================================

  function downloadImage(dataUrl, fileName) {
    const link = document.createElement("a");
    link.href = dataUrl;
    link.download = `${fileName}.png`;
    link.click();
  }

  function deleteCampaign(id) {
    let campaigns = JSON.parse(localStorage.getItem("campaigns") || "[]");
    campaigns = campaigns.filter((c) => c.id !== id);
    localStorage.setItem("campaigns", JSON.stringify(campaigns));
    renderCampaigns();
  }

  // ============================================
  // FUNCIONES - UTILIDADES
  // ============================================

  function formatDate(dateString) {
    const [year, month, day] = dateString.split("-");
    return `${day}/${month}/${year}`;
  }

  function getImageFileName(cityName, duplaIndex) {
    const suffix = duplaIndex === 0 ? "1" : "5";
    return `${cityName}${suffix}`;
  }

  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>

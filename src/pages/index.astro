---
import Layout1 from "../layouts/Layout1.astro";
import Header from "../sections/header.astro";
import CreateCity from "../components/create_city.astro";
---

<Layout1 title="Dashboard">
  <Header />
  <CreateCity />

  <!-- VISTA GENERAL DEL DASHBOARD -->
  <section id="dashboard" class="flex-row">
    <div id="pendiente" class="flex-column">
      <h2>PENDIENTES</h2>
    </div>
    <div id="montada" class="flex-column">
      <h2>MONTADAS</h2>
    </div>
  </section>
</Layout1>

<style>
  #dashboard {
    display: flex;
    align-items: flex-start;
    gap: 0px;
    padding: 10px;
    max-width: 1100px;
    height: 100%;
    overflow: hidden;
  }

  #pendiente,
  #montada {
    width: 100%;
    height: 100%;
    text-align: center;
    padding: 20px;
    gap: 10px;
    justify-content: flex-start;
    overflow: hidden;
    flex-direction: column;
  }

  #pendiente h2,
  #montada h2 {
    color: var(--clr-main);
    margin-bottom: 15px;
    font-size: 1.3rem;
    flex-shrink: 0;
  }
</style>

<style is:inline>
  .campaigns-container {
    width: 100%;
    max-width: 500px;
    gap: 10px;
    justify-content: flex-start;
    overflow-y: auto;
    height: 100%;
    flex: 1;
  }

  .campaign-card {
    background-color: var(--clr-dark2);
    padding: 10px 15px;
    width: 100%;
    gap: 5px;
    position: relative;
    border: solid 1px var(--clr-border);
    text-align: left;
    height: auto;
    flex-shrink: 0;
  }

  .campaign-header {
    width: 100%;
    gap: 5px;
    padding-bottom: 5px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .campaign-header h5 {
    color: var(--clr-main);
    font-size: 1.1rem;
    margin: 0;
  }

  .campaign-header p {
    font-size: 0.85rem;
    color: var(--clr-text);
    display: flex;
    gap: 7px;
    margin: 0;
  }

  .campaign-header.clickable {
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .bloque {
    padding: 5px;
    width: 100%;
    gap: 10px;
    background-color: var(--clr-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bloque h6 {
    width: 100%;
    color: var(--clr-main);
    font-size: 0.8rem;
    text-align: left;
    font-weight: 600;
    margin: 0;
  }

  .bloque-content {
    width: 100%;
    display: flex;
    flex-direction: row;
    gap: 10px;
  }

  .bloque-item {
    flex: 1;
    background-color: var(--clr-dark);
    padding: 0px;
    gap: 4px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bloque-item img {
    width: 192px;
    height: 192px;
    object-fit: cover;
    border: solid 1px var(--clr-border);
  }

  .bloque-item p {
    padding: 8px;
    background-color: var(--clr-dark);
    border: solid 1px var(--clr-border);
    color: var(--clr-text);
    font-size: 0.85rem;
    line-height: 1.2;
    height: 192px;
    width: 192px;
    overflow: hidden;
    overflow-wrap: break-word;
    margin: 0;
  }

  .bloque-item button {
    width: 100%;
    font-size: 0.8rem;
    padding: 8px 12px;
    gap: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .bloque-item button i {
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .campaign-detail-modal {
    background-color: var(--clr-dark);
    border: solid 1px var(--clr-border);
    width: 470px;
    max-width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    padding: 15px 20px;
    scroll-behavior: smooth;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 10px;
    justify-content: flex-start;
  }

  .campaign-detail-modal .campaign-header {
    width: 100%;
    gap: 5px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .campaign-detail-modal .campaign-header .header-top {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .campaign-detail-modal .campaign-header h5 {
    color: var(--clr-main);
    font-size: 1.1rem;
    cursor: pointer;
    margin: 0;
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  .header-actions i {
    background-color: var(--clr-dark2);
    border: solid 1px var(--clr-border);
    color: var(--clr-gray);
    padding: 8px;
    cursor: pointer;
    transition: var(--transition);
  }

  .campaign-detail-modal .campaign-header p {
    font-size: 0.85rem;
    color: var(--clr-gray);
    display: flex;
    gap: 7px;
    margin: 0;
  }

  .campaign-detail-modal .campaign-header p:first-of-type {
    cursor: pointer;
  }

  .campaign-detail-modal .duplas-detail {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .campaign-status-switcher-modal {
    width: 100%;
    display: flex;
    gap: 7px;
    margin-top: 7px;
  }

  .status-btn {
    flex: 1;
    padding: 8px 12px;
    font-size: 0.75rem;
    border: solid 1px var(--clr-border);
    background-color: var(--clr-dark);
    color: var(--clr-gray);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-btn.active {
    background-color: var(--clr-main);
    color: var(--clr-dark);
    border-color: var(--clr-main);
  }

  /* textos si no hay campañas en cada sección */
  .empty-text {
    color: var(--clr-gray);
  }

  .empty-state {
    width: 100%;
    padding: 60px 20px;
    gap: 15px;
    color: var(--clr-gray);
  }

  .empty-state i {
    font-size: 3rem;
  }

  .empty-state h4 {
    color: var(--clr-text);
  }

  @media (hover: hover) {
    .campaign-header.clickable:hover {
      opacity: 0.8;
    }

    .header-actions i:hover {
      color: var(--clr-main);
      background-color: var(--clr-border);
    }

    .status-btn:hover {
      background-color: var(--clr-border);
    }

    .status-btn.active:hover {
      background-color: var(--clr-main);
    }
  }
</style>

<script>
  //@ts-nocheck
  import {
    getCampaigns,
    deleteCampaign,
    updateCampaignStatus,
  } from "../lib/database.js";

  const $dashboard = document.getElementById("dashboard");

  document.addEventListener("DOMContentLoaded", renderCampaigns);
  window.addEventListener("campaignAdded", renderCampaigns);

  // Renderiza todas las campañas separadas por estado
  async function renderCampaigns() {
    const campaigns = await getCampaigns();

    if (campaigns.length === 0) {
      $dashboard.innerHTML = `
        <div class="empty-state flex-column">
          <i class="bi bi-inbox"></i>
          <h4>No hay campañas aún</h4>
          <p>Haz clic en el botón + para crear tu primera campaña</p>
        </div>
      `;
      return;
    }

    const pendientes = campaigns.filter((c) => c.status === "pendiente");
    const montadas = campaigns.filter((c) => c.status === "montada");

    const $pendienteDiv = document.getElementById("pendiente");
    const $montadaDiv = document.getElementById("montada");

    $pendienteDiv.innerHTML = `
      <h2>PENDIENTES</h2>
      <div class="campaigns-container flex-column">
        ${pendientes.length === 0 ? '<p class="empty-text">Sin campañas pendientes</p>' : ""}
        ${pendientes.map((campaign) => renderCampaignCard(campaign)).join("")}
      </div>
    `;

    $montadaDiv.innerHTML = `
      <h2>MONTADAS</h2>
      <div class="campaigns-container flex-column">
        ${montadas.length === 0 ? '<p class="empty-text">Sin campañas montadas</p>' : ""}
        ${montadas.map((campaign) => renderCampaignCard(campaign)).join("")}
      </div>
    `;

    addEventListeners();
  }

  // Renderiza una tarjeta de campaña
  function renderCampaignCard(campaign) {
    return `
      <div class="campaign-card flex-column" data-id="${campaign.id}" data-status="${campaign.status}">
        <div class="campaign-header clickable">
          <h5>${campaign.city_name}</h5>
          <p><i class="bi bi-calendar3"></i> ${formatDate(campaign.start_date)}</p>
          <p><i class="bi bi-telephone-fill"></i> ${campaign.phone_number}</p>
        </div>
      </div>
    `;
  }

  // Agrega todos los event listeners dinámicos
  function addEventListeners() {
    addCopyClickListener();
    addCardClickListener();
  }

  // Permite copiar texto al hacer click en elementos con [data-copy]
  function addCopyClickListener() {
    document.querySelectorAll("[data-copy]").forEach((element) => {
      element.addEventListener("click", (e) => {
        const text = e.currentTarget.dataset.copy;
        navigator.clipboard.writeText(text).then(() => {
          e.currentTarget.style.opacity = "0.7";
          setTimeout(() => {
            e.currentTarget.style.opacity = "1";
          }, 500);
        });
      });
    });
  }

  // Abre el modal de detalles al hacer click en la tarjeta
  async function addCardClickListener() {
    document
      .querySelectorAll(".campaign-header.clickable")
      .forEach((header) => {
        header.addEventListener("click", async (e) => {
          const card = e.currentTarget.closest(".campaign-card");
          const id = parseInt(card.dataset.id);
          const campaigns = await getCampaigns();
          const campaign = campaigns.find((c) => c.id === id);
          if (campaign) openCampaignModal(campaign);
        });
      });
  }

  // Descarga una imagen
  function downloadImage(dataUrl, fileName) {
    const link = document.createElement("a");
    link.href = dataUrl;
    link.download = `${fileName}.png`;
    link.click();
  }

  // Elimina una campaña de la base de datos
  async function deleteCampaignHandler(id) {
    const success = await deleteCampaign(id);
    if (success) {
      await renderCampaigns();
    } else {
      alert("Error al eliminar la campaña");
    }
  }

  // Cambia el estado de una campaña
  async function changeCampaignStatus(id, newStatus) {
    const success = await updateCampaignStatus(id, newStatus);
    if (success) {
      await renderCampaigns();
    } else {
      alert("Error al cambiar el estado");
    }
  }

  // Abre modal con detalles completos de una campaña
  function openCampaignModal(campaign) {
    const modalHtml = `
      <div class="modal-overlay" id="campaign-detail-overlay" style="display: flex; z-index: 50;">
        <i class="bi bi-x-lg close-campaign-modal" style="position: fixed; top: 20px; right: 20px; cursor: pointer; font-size: 20px; background-color: var(--clr-dark); border: solid 1px var(--clr-border); padding: 7px; z-index: 100;"></i>
        <div class="campaign-detail-modal flex-column">
          <div class="campaign-header">
            <div class="header-top">
              <h5 data-copy="${campaign.city_name}">${campaign.city_name}</h5>
              <div class="header-actions">
                <i class="bi bi-pencil-square edit-campaign-modal" data-id="${campaign.id}"></i>
                <i class="bi bi-trash delete-campaign-modal" data-id="${campaign.id}"></i>
              </div>
            </div>
            <p data-copy="${formatDate(campaign.start_date)}"><i class="bi bi-calendar3"></i> ${formatDate(campaign.start_date)}</p>
            <p><i class="bi bi-telephone-fill"></i> ${campaign.phone_number}</p>
          </div>
          <hr />
          <div class="duplas-detail">
            ${campaign.duplas
              .sort((a, b) => a.dupla_order - b.dupla_order)
              .map(
                (dupla) => `
              <div class="bloque">
                <h6>DUPLA #${dupla.dupla_order}: ${dupla.name}</h6>
                <div class="bloque-content">
                  <div class="bloque-item">
                    <img src="${dupla.image_url}" alt="Imagen ${dupla.name}" />
                    <button class="boton download-img" data-img="${dupla.image_url}" data-name="${getImageFileName(campaign.city_name, dupla.dupla_order - 1)}">
                      <i class="bi bi-download"></i>
                    </button>
                  </div>
                  <div class="bloque-item">
                    <p>${escapeHtml(dupla.text)}</p>
                    <button class="boton copy-text" data-text="${escapeHtml(dupla.text)}">
                      <i class="bi bi-clipboard"></i>
                    </button>
                  </div>
                </div>
              </div>
            `,
              )
              .join("")}
          </div>
          <hr />
          <div class="campaign-status-switcher-modal">
            <button class="status-btn ${campaign.status === "pendiente" ? "active" : ""}" data-status="pendiente" data-id="${campaign.id}">PENDIENTE</button>
            <button class="status-btn ${campaign.status === "montada" ? "active" : ""}" data-status="montada" data-id="${campaign.id}">MONTADA</button>
          </div>
        </div>
      </div>
    `;

    const modalDiv = document.createElement("div");
    modalDiv.innerHTML = modalHtml;
    document.body.appendChild(modalDiv.firstElementChild);

    const $detailOverlay = document.getElementById("campaign-detail-overlay");
    const $closeBtn = $detailOverlay.querySelector(".close-campaign-modal");
    const $editBtn = $detailOverlay.querySelector(".edit-campaign-modal");
    const $deleteBtn = $detailOverlay.querySelector(".delete-campaign-modal");

    const closeDetailModal = () => {
      $detailOverlay.remove();
    };

    // Cerrar modal
    $closeBtn.addEventListener("click", closeDetailModal);
    $detailOverlay.addEventListener("click", (e) => {
      if (e.target === $detailOverlay) closeDetailModal();
    });

    // Editar campaña
    $editBtn.addEventListener("click", async (e) => {
      const id = parseInt(e.currentTarget.dataset.id);
      const campaigns = await getCampaigns();
      const campaignToEdit = campaigns.find((c) => c.id === id);
      if (campaignToEdit) {
        window.dispatchEvent(
          new CustomEvent("editCampaign", { detail: campaignToEdit }),
        );
        closeDetailModal();
      }
    });

    // Eliminar campaña
    $deleteBtn.addEventListener("click", (e) => {
      const id = parseInt(e.currentTarget.dataset.id);
      const $confirmOverlay = document.getElementById("modal-confirm-overlay");
      const $confirmMessage = document.getElementById("confirm-message");
      const $confirmYes = document.querySelector(".confirm-yes");

      $confirmMessage.textContent = "¿Estás seguro de eliminar esta campaña?";
      $confirmOverlay.style.display = "flex";

      const handleConfirm = async () => {
        await deleteCampaignHandler(id);
        closeDetailModal();
        $confirmOverlay.style.display = "none";
        $confirmYes.removeEventListener("click", handleConfirm);
      };

      $confirmYes.addEventListener("click", handleConfirm);
    });

    // Botones dentro del modal
    $detailOverlay.querySelectorAll("[data-copy]").forEach((element) => {
      element.addEventListener("click", (e) => {
        const text = e.currentTarget.dataset.copy;
        navigator.clipboard.writeText(text).then(() => {
          e.currentTarget.style.opacity = "0.7";
          setTimeout(() => {
            e.currentTarget.style.opacity = "1";
          }, 500);
        });
      });
    });

    $detailOverlay.querySelectorAll(".copy-text").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const text = e.currentTarget.dataset.text;
        navigator.clipboard.writeText(text).then(() => {
          const originalText = e.currentTarget.innerHTML;
          e.currentTarget.innerHTML = '<i class="bi bi-check"></i> Copiado!';
          setTimeout(() => {
            e.currentTarget.innerHTML = originalText;
          }, 1500);
        });
      });
    });

    $detailOverlay.querySelectorAll(".download-img").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const imgData = e.currentTarget.dataset.img;
        const fileName = e.currentTarget.dataset.name;
        downloadImage(imgData, fileName);
      });
    });

    $detailOverlay
      .querySelectorAll(".campaign-status-switcher-modal .status-btn")
      .forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const id = parseInt(e.currentTarget.dataset.id);
          const newStatus = e.currentTarget.dataset.status;
          await changeCampaignStatus(id, newStatus);
          closeDetailModal();
        });
      });
  }

  // Formatea una fecha de YYYY-MM-DD a DD/MM/YYYY
  function formatDate(dateString) {
    const [year, month, day] = dateString.split("-");
    return `${day}/${month}/${year}`;
  }

  // Genera nombre de archivo para descargas
  function getImageFileName(cityName, duplaIndex) {
    const suffix = duplaIndex === 0 ? "1" : "5";
    return `${cityName}${suffix}`;
  }

  // Escapa caracteres especiales de HTML
  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>

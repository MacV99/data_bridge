---
import Layout1 from "../layouts/Layout1.astro";
import Header from "../sections/header.astro";
import CreateCity from "../components/create_city.astro";
---

<Layout1 title="Dashboard">
  <Header />
  <CreateCity />

  <!-- OVERLAY DE CARGA INICIAL -->
  <div id="loading-initial" class="loading-overlay">
    <div class="flex-column" style="gap: 15px;">
      <div class="spinner"></div>
      <p style="color: var(--clr-text); font-size: 0.9rem;">
        Cargando campañas...
      </p>
    </div>
  </div>

  <!-- VISTA GENERAL DEL DASHBOARD -->
  <section id="dashboard" class="flex-row">
    <div id="pendiente" class="flex-column"></div>
    <div id="montada" class="flex-column"></div>
  </section>
</Layout1>

<style>
  #dashboard {
    display: flex;
    align-items: flex-start;
    gap: 0px;
    padding: 10px;
    max-width: 1100px;
    height: 100%;
    overflow: hidden;
  }

  #pendiente,
  #montada {
    width: 100%;
    height: 100%;
    text-align: center;
    padding: 20px;
    gap: 10px;
    justify-content: flex-start;
    overflow: hidden;
    flex-direction: column;
  }

  @media (hover: hover) {
    .filter-btn:hover {
      background-color: var(--clr-border);
      color: var(--clr-white);
    }

    .dropdown-item:hover {
      background-color: var(--clr-border);
      color: var(--clr-white);
    }
  }
</style>

<style is:inline>
  .header-section {
    width: 100%;
    justify-content: center;
    align-items: center;
    margin-bottom: 15px;
    flex-shrink: 0;
    gap: 10px;
    line-height: 1;
  }

  .header-section h2 {
    color: var(--clr-main);
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 8px;
    line-height: 1;
  }

  .header-section h2 .counter {
    color: var(--clr-text);
    font-size: 0.9rem;
    font-weight: 400;
    background-color: var(--clr-dark2);
    padding: 0;
    height: 32px;
    width: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    line-height: 1;
  }

  /* === DROPDOWN DE ORDENAMIENTO === */
  .filter-dropdown {
    display: flex;
    align-self: flex-end;
  }

  .filter-btn {
    background-color: var(--clr-dark2);
    border: solid 1px var(--clr-border);
    border-radius: 10px;
    color: var(--clr-gray);
    padding: 0;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    height: 32px;
    width: 32px;
    line-height: 1;
  }

  .dropdown-menu {
    position: absolute;
    top: calc(100% + 5px);
    right: 0;
    background-color: var(--clr-dark);
    border: solid 1px var(--clr-border);
    min-width: 140px;
    z-index: 10;
    display: none;
    flex-direction: column;
    overflow: hidden;
  }

  .dropdown-menu.show {
    display: flex;
  }

  .dropdown-item {
    padding: 10px 15px;
    cursor: pointer;
    transition: var(--transition);
    color: var(--clr-text);
    font-size: 0.85rem;
    text-align: left;
    border-bottom: solid 1px var(--clr-border);
    border-radius: 0px;
  }

  .dropdown-item:last-child {
    border-bottom: none;
  }

  .campaigns-container {
    width: 100%;
    max-width: 500px;
    gap: 10px;
    justify-content: flex-start;
    overflow-y: auto;
    height: 100%;
    flex: 1;
  }

  .campaign-card {
    background-color: var(--clr-dark2);
    padding: 10px 15px;
    width: 100%;
    gap: 5px;
    position: relative;
    border: solid 1px var(--clr-border);
    text-align: left;
    height: auto;
    flex-shrink: 0;
  }

  .campaign-header {
    width: 100%;
    gap: 5px;
    padding-bottom: 5px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .campaign-header h5 {
    color: var(--clr-main);
    font-size: 1.1rem;
    margin: 0;
    cursor: pointer;
    transition: opacity 0.2s;
    user-select: none;
  }

  .campaign-header p {
    font-size: 0.85rem;
    color: var(--clr-text);
    display: flex;
    gap: 7px;
    margin: 0;
  }

  .campaign-header.clickable {
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .bloque {
    padding: 5px;
    width: 100%;
    gap: 10px;
    background-color: var(--clr-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bloque h6 {
    width: 100%;
    color: var(--clr-main);
    font-size: 0.8rem;
    text-align: left;
    font-weight: 600;
    margin: 0;
  }

  .bloque-content {
    width: 100%;
    display: flex;
    flex-direction: row;
    gap: 10px;
  }

  .bloque-item {
    flex: 1;
    background-color: var(--clr-dark);
    padding: 0px;
    gap: 4px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bloque-item img {
    width: 192px;
    height: 192px;
    object-fit: cover;
    border: solid 1px var(--clr-border);
  }

  .bloque-item p {
    padding: 8px;
    background-color: var(--clr-dark);
    border: solid 1px var(--clr-border);
    color: var(--clr-text);
    font-size: 0.85rem;
    line-height: 1.2;
    height: 192px;
    width: 192px;
    overflow: hidden;
    overflow-wrap: break-word;
    margin: 0;
  }

  .bloque-item button {
    width: 100%;
    font-size: 0.8rem;
    padding: 8px 12px;
    gap: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .bloque-item button i {
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .campaign-detail-modal {
    background-color: var(--clr-dark);
    border: solid 1px var(--clr-border);
    width: 470px;
    max-width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    padding: 15px 20px;
    scroll-behavior: smooth;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 5px;
    justify-content: flex-start;
  }

  .campaign-detail-modal .campaign-header {
    width: 100%;
    gap: 5px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .campaign-detail-modal .campaign-header .header-top {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .campaign-detail-modal .campaign-header h5 {
    color: var(--clr-main);
    font-size: 1.1rem;
    cursor: pointer;
    margin: 0;
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  .header-actions i {
    background-color: var(--clr-dark2);
    border: solid 1px var(--clr-border);
    color: var(--clr-gray);
    padding: 8px;
    cursor: pointer;
    transition: var(--transition);
  }

  .campaign-detail-modal .campaign-header p {
    font-size: 0.85rem;
    color: var(--clr-text);
    display: flex;
    gap: 7px;
    margin: 0;
  }

  .campaign-detail-modal .campaign-header p:first-of-type {
    cursor: pointer;
  }

  .campaign-detail-modal .duplas-detail {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .campaign-status-switcher-modal {
    width: 100%;
    display: flex;
    gap: 7px;
    margin-top: 7px;
  }

  .status-btn {
    flex: 1;
    padding: 8px 12px;
    font-size: 0.75rem;
    border: solid 1px var(--clr-border);
    background-color: var(--clr-dark);
    color: var(--clr-gray);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-btn.active {
    background-color: var(--clr-main);
    color: var(--clr-dark);
    border-color: var(--clr-main);
  }

  /* textos si no hay campañas en cada sección */
  .empty-text {
    color: var(--clr-gray);
  }

  .empty-state {
    width: 100%;
    padding: 60px 20px;
    gap: 15px;
    color: var(--clr-gray);
  }

  .empty-state i {
    font-size: 3rem;
  }

  .empty-state h4 {
    color: var(--clr-text);
  }

  @media (hover: hover) {
    .campaign-header h5:hover {
      opacity: 0.7;
    }

    .campaign-header.clickable:hover {
      opacity: 0.8;
    }

    .header-actions i:hover {
      color: var(--clr-main);
      background-color: var(--clr-border);
    }

    .status-btn:hover {
      background-color: var(--clr-border);
    }

    .dropdown-item:hover {
      background-color: var(--clr-border);
    }
  }
</style>

<script>
  //@ts-nocheck
  import {
    getCampaigns,
    deleteCampaign,
    updateCampaignStatus,
  } from "../lib/database.js";

  const $dashboard = document.getElementById("dashboard");
  const $loadingInitial = document.getElementById("loading-initial");

  // Variable global para almacenar todas las campañas (carga única)
  let allCampaigns = [];

  // Estado de ordenamiento actual
  let currentSortPendiente = "all"; // all, DARIO, CURSOS
  let currentSortMontada = "all";

  // Cargar campañas al inicio
  document.addEventListener("DOMContentLoaded", async () => {
    $loadingInitial.style.display = "flex";
    await loadCampaigns();
    renderCampaigns();
    $loadingInitial.style.display = "none";
  });

  // Recargar cuando se agrega/edita una campaña
  window.addEventListener("campaignAdded", async () => {
    await loadCampaigns();
    renderCampaigns();
  });

  // Cerrar dropdowns al hacer clic fuera
  document.addEventListener("click", () => {
    document.querySelectorAll(".dropdown-menu").forEach((menu) => {
      menu.classList.remove("show");
    });
  });

  // Carga todas las campañas una sola vez
  async function loadCampaigns() {
    allCampaigns = await getCampaigns();
  }

  // Renderiza todas las campañas separadas por estado (usa datos cargados, no recarga)
  function renderCampaigns() {
    if (allCampaigns.length === 0) {
      $dashboard.innerHTML = `
      <div class="empty-state flex-column">
        <i class="bi bi-inbox"></i>
        <h4>No hay campañas aún</h4>
        <p>Haz clic en el botón + para crear tu primera campaña</p>
      </div>
    `;
      return;
    }

    let pendientes = allCampaigns.filter((c) => c.status === "pendiente");
    let montadas = allCampaigns.filter((c) => c.status === "montada");

    // Aplicar ordenamiento
    pendientes = sortCampaigns(pendientes, currentSortPendiente);
    montadas = sortCampaigns(montadas, currentSortMontada);

    const $pendienteDiv = document.getElementById("pendiente");
    const $montadaDiv = document.getElementById("montada");

    $pendienteDiv.innerHTML = `
    <div class="header-section flex-row">
      <h2>PENDIENTES <span class="counter" id="counter-pendiente">${pendientes.length}</span></h2>
      <div class="filter-dropdown">
        <button class="filter-btn" id="filter-btn-pendiente" data-sort="${currentSortPendiente}">
          <i class="bi bi-sort-down-alt"></i>
        </button>
        <div class="dropdown-menu" id="dropdown-pendiente">
          <div class="dropdown-item ${currentSortPendiente === "all" ? "active" : ""}" data-value="all">TODOS</div>
          <div class="dropdown-item ${currentSortPendiente === "DARIO" ? "active" : ""}" data-value="DARIO">DARIO</div>
          <div class="dropdown-item ${currentSortPendiente === "CURSOS" ? "active" : ""}" data-value="CURSOS">CURSOS</div>
        </div>
      </div>
    </div>
    <div class="campaigns-container flex-column">
      ${pendientes.length === 0 ? '<p class="empty-text">Sin campañas pendientes</p>' : ""}
      ${pendientes.map((campaign) => renderCampaignCard(campaign)).join("")}
    </div>
  `;

    $montadaDiv.innerHTML = `
    <div class="header-section flex-row">
      <h2>MONTADAS <span class="counter" id="counter-montada">${montadas.length}</span></h2>
      <div class="filter-dropdown">
        <button class="filter-btn" id="filter-btn-montada" data-sort="${currentSortMontada}">
          <i class="bi bi-sort-down-alt"></i>
        </button>
        <div class="dropdown-menu" id="dropdown-montada">
          <div class="dropdown-item ${currentSortMontada === "all" ? "active" : ""}" data-value="all">TODOS</div>
          <div class="dropdown-item ${currentSortMontada === "DARIO" ? "active" : ""}" data-value="DARIO">DARIO</div>
          <div class="dropdown-item ${currentSortMontada === "CURSOS" ? "active" : ""}" data-value="CURSOS">CURSOS</div>
        </div>
      </div>
    </div>
    <div class="campaigns-container flex-column">
      ${montadas.length === 0 ? '<p class="empty-text">Sin campañas montadas</p>' : ""}
      ${montadas.map((campaign) => renderCampaignCard(campaign)).join("")}
    </div>
  `;

    // Re-agregar event listeners para los nuevos dropdowns
    setupDropdownListeners();
    addEventListeners();
  }

  // Configura los listeners de los dropdowns después de renderizar
  function setupDropdownListeners() {
    const newFilterBtnPendiente = document.getElementById(
      "filter-btn-pendiente",
    );
    const newFilterBtnMontada = document.getElementById("filter-btn-montada");
    const newDropdownPendiente = document.getElementById("dropdown-pendiente");
    const newDropdownMontada = document.getElementById("dropdown-montada");

    // Toggle dropdowns
    newFilterBtnPendiente?.addEventListener("click", (e) => {
      e.stopPropagation();
      newDropdownPendiente.classList.toggle("show");
      newDropdownMontada.classList.remove("show");
    });

    newFilterBtnMontada?.addEventListener("click", (e) => {
      e.stopPropagation();
      newDropdownMontada.classList.toggle("show");
      newDropdownPendiente.classList.remove("show");
    });

    // Items de pendientes
    newDropdownPendiente?.querySelectorAll(".dropdown-item").forEach((item) => {
      item.addEventListener("click", (e) => {
        const value = e.currentTarget.dataset.value;
        currentSortPendiente = value;
        newFilterBtnPendiente.dataset.sort = value;

        newDropdownPendiente.querySelectorAll(".dropdown-item").forEach((i) => {
          i.classList.remove("active");
        });
        e.currentTarget.classList.add("active");

        newDropdownPendiente.classList.remove("show");
        renderCampaigns();
      });
    });

    // Items de montadas
    newDropdownMontada?.querySelectorAll(".dropdown-item").forEach((item) => {
      item.addEventListener("click", (e) => {
        const value = e.currentTarget.dataset.value;
        currentSortMontada = value;
        newFilterBtnMontada.dataset.sort = value;

        newDropdownMontada.querySelectorAll(".dropdown-item").forEach((i) => {
          i.classList.remove("active");
        });
        e.currentTarget.classList.add("active");

        newDropdownMontada.classList.remove("show");
        renderCampaigns();
      });
    });
  }

  // Ordena las campañas según el criterio seleccionado
  function sortCampaigns(campaigns, sortBy) {
    // Crear copia para no mutar el original
    const sorted = [...campaigns];

    if (sortBy === "DARIO") {
      // DARIO primero, luego CURSOS
      return sorted.sort((a, b) => {
        if (a.phone_number === "DARIO" && b.phone_number !== "DARIO") return -1;
        if (a.phone_number !== "DARIO" && b.phone_number === "DARIO") return 1;
        return 0;
      });
    } else if (sortBy === "CURSOS") {
      // CURSOS primero, luego DARIO
      return sorted.sort((a, b) => {
        if (a.phone_number === "CURSOS" && b.phone_number !== "CURSOS")
          return -1;
        if (a.phone_number !== "CURSOS" && b.phone_number === "CURSOS")
          return 1;
        return 0;
      });
    }

    // Por defecto: todas sin orden especial (orden original por fecha)
    return sorted;
  }

  // Renderiza una tarjeta de campaña
  function renderCampaignCard(campaign) {
    return `
      <div class="campaign-card flex-column" data-id="${campaign.id}" data-status="${campaign.status}">
        <div class="campaign-header clickable">
          <h5 class="copy-city-name" data-city="${campaign.city_name}">${campaign.city_name}</h5>
          <p><i class="bi bi-calendar3"></i> ${formatDate(campaign.start_date)}</p>
          <p><i class="bi bi-telephone-fill"></i> ${campaign.phone_number}</p>
        </div>
      </div>
    `;
  }

  // Agrega todos los event listeners dinámicos
  function addEventListeners() {
    addCopyClickListener();
    addCardClickListener();
    addCityNameCopyListener();
  }

  // Permite copiar texto al hacer click en elementos con [data-copy]
  function addCopyClickListener() {
    document.querySelectorAll("[data-copy]").forEach((element) => {
      element.addEventListener("click", (e) => {
        const text = e.currentTarget.dataset.copy;
        navigator.clipboard.writeText(text).then(() => {
          e.currentTarget.style.opacity = "0.7";
          setTimeout(() => {
            e.currentTarget.style.opacity = "1";
          }, 500);
        });
      });
    });
  }

  // Copia el nombre de la ciudad sin formato al hacer clic
  function addCityNameCopyListener() {
    document.querySelectorAll(".copy-city-name").forEach((element) => {
      element.addEventListener("click", (e) => {
        e.stopPropagation(); // Evitar que abra el modal
        const cityName = e.currentTarget.dataset.city;

        // Copiar al portapapeles sin formato
        navigator.clipboard.writeText(cityName).then(() => {
          const originalOpacity = e.currentTarget.style.opacity;
          e.currentTarget.style.opacity = "0.5";
          setTimeout(() => {
            e.currentTarget.style.opacity = originalOpacity || "1";
          }, 300);
        });
      });
    });
  }

  // Abre el modal de detalles al hacer click en la tarjeta
  async function addCardClickListener() {
    document
      .querySelectorAll(".campaign-header.clickable")
      .forEach((header) => {
        header.addEventListener("click", async (e) => {
          // Si el click fue en el h5, no hacer nada (ya se copió)
          if (e.target.classList.contains("copy-city-name")) {
            return;
          }

          const card = e.currentTarget.closest(".campaign-card");
          const id = parseInt(card.dataset.id);
          // Usar allCampaigns en lugar de volver a llamar getCampaigns
          const campaign = allCampaigns.find((c) => c.id === id);
          if (campaign) openCampaignModal(campaign);
        });
      });
  }

  // Descarga una imagen
  function downloadImage(dataUrl, fileName) {
    const link = document.createElement("a");
    link.href = dataUrl;
    link.download = `${fileName}.png`;
    link.click();
  }

  // Elimina una campaña de la base de datos
  async function deleteCampaignHandler(id) {
    const success = await deleteCampaign(id);
    if (success) {
      await loadCampaigns();
      renderCampaigns();
    } else {
      alert("Error al eliminar la campaña");
    }
  }

  // Cambia el estado de una campaña
  async function changeCampaignStatus(id, newStatus) {
    const success = await updateCampaignStatus(id, newStatus);
    if (success) {
      await loadCampaigns();
      renderCampaigns();
    } else {
      alert("Error al cambiar el estado");
    }
  }

  // Abre modal con detalles completos de una campaña
  function openCampaignModal(campaign) {
    const modalHtml = `
      <div class="modal-overlay" id="campaign-detail-overlay" style="display: flex; z-index: 50;">
        <i class="bi bi-x-lg close-campaign-modal" style="position: fixed; top: 20px; right: 20px; cursor: pointer; font-size: 20px; background-color: var(--clr-dark); border: solid 1px var(--clr-border); padding: 7px; z-index: 100;"></i>
        <div class="campaign-detail-modal flex-column">
          <div class="campaign-header">
            <div class="header-top">
              <h5 data-copy="${campaign.city_name}">${campaign.city_name}</h5>
              <div class="header-actions">
                <i class="bi bi-pencil-square edit-campaign-modal" data-id="${campaign.id}"></i>
                <i class="bi bi-trash delete-campaign-modal" data-id="${campaign.id}"></i>
              </div>
            </div>
            <p data-copy="${formatDate(campaign.start_date)}"><i class="bi bi-calendar3"></i> ${formatDate(campaign.start_date)}</p>
            <p><i class="bi bi-telephone-fill"></i> ${campaign.phone_number}</p>
          </div>
          <hr />
          <div class="duplas-detail">
            ${campaign.duplas
              .sort((a, b) => a.dupla_order - b.dupla_order)
              .map(
                (dupla) => `
              <div class="bloque">
                <h6>DUPLA #${dupla.dupla_order}: ${dupla.name}</h6>
                <div class="bloque-content">
                  <div class="bloque-item">
                    <img src="${dupla.image_url}" alt="Imagen ${dupla.name}" />
                    <button class="boton download-img" data-img="${dupla.image_url}" data-name="${getImageFileName(campaign.city_name, dupla.dupla_order - 1)}">
                      <i class="bi bi-download"></i>
                    </button>
                  </div>
                  <div class="bloque-item">
                    <p>${escapeHtml(dupla.text)}</p>
                    <button class="boton copy-text" data-text="${escapeHtml(dupla.text)}">
                      <i class="bi bi-clipboard"></i>
                    </button>
                  </div>
                </div>
              </div>
            `,
              )
              .join("")}
          </div>
          <hr />
          <div class="campaign-status-switcher-modal">
            <button class="status-btn ${campaign.status === "pendiente" ? "active" : ""}" data-status="pendiente" data-id="${campaign.id}">PENDIENTE</button>
            <button class="status-btn ${campaign.status === "montada" ? "active" : ""}" data-status="montada" data-id="${campaign.id}">MONTADA</button>
          </div>
        </div>
      </div>
    `;

    const modalDiv = document.createElement("div");
    modalDiv.innerHTML = modalHtml;
    document.body.appendChild(modalDiv.firstElementChild);

    const $detailOverlay = document.getElementById("campaign-detail-overlay");
    const $closeBtn = $detailOverlay.querySelector(".close-campaign-modal");
    const $editBtn = $detailOverlay.querySelector(".edit-campaign-modal");
    const $deleteBtn = $detailOverlay.querySelector(".delete-campaign-modal");

    const closeDetailModal = () => {
      $detailOverlay.remove();
    };

    // Cerrar modal
    $closeBtn.addEventListener("click", closeDetailModal);
    $detailOverlay.addEventListener("click", (e) => {
      if (e.target === $detailOverlay) closeDetailModal();
    });

    // Editar campaña
    $editBtn.addEventListener("click", async (e) => {
      const id = parseInt(e.currentTarget.dataset.id);
      const campaignToEdit = allCampaigns.find((c) => c.id === id);
      if (campaignToEdit) {
        window.dispatchEvent(
          new CustomEvent("editCampaign", { detail: campaignToEdit }),
        );
        closeDetailModal();
      }
    });

    // Eliminar campaña
    $deleteBtn.addEventListener("click", (e) => {
      const id = parseInt(e.currentTarget.dataset.id);
      const $confirmOverlay = document.getElementById("modal-confirm-overlay");
      const $confirmMessage = document.getElementById("confirm-message");
      const $confirmYes = document.querySelector(".confirm-yes");

      $confirmMessage.textContent = "¿Estás seguro de eliminar esta campaña?";
      $confirmOverlay.style.display = "flex";

      const handleConfirm = async () => {
        await deleteCampaignHandler(id);
        closeDetailModal();
        $confirmOverlay.style.display = "none";
        $confirmYes.removeEventListener("click", handleConfirm);
      };

      $confirmYes.addEventListener("click", handleConfirm);
    });

    // Botones dentro del modal
    $detailOverlay.querySelectorAll("[data-copy]").forEach((element) => {
      element.addEventListener("click", (e) => {
        const text = e.currentTarget.dataset.copy;
        navigator.clipboard.writeText(text).then(() => {
          e.currentTarget.style.opacity = "0.7";
          setTimeout(() => {
            e.currentTarget.style.opacity = "1";
          }, 500);
        });
      });
    });

    $detailOverlay.querySelectorAll(".copy-text").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const text = e.currentTarget.dataset.text;
        navigator.clipboard.writeText(text).then(() => {
          const originalText = e.currentTarget.innerHTML;
          e.currentTarget.innerHTML = '<i class="bi bi-check"></i> Copiado!';
          setTimeout(() => {
            e.currentTarget.innerHTML = originalText;
          }, 1500);
        });
      });
    });

    $detailOverlay.querySelectorAll(".download-img").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const imgData = e.currentTarget.dataset.img;
        const fileName = e.currentTarget.dataset.name;
        downloadImage(imgData, fileName);
      });
    });

    $detailOverlay
      .querySelectorAll(".campaign-status-switcher-modal .status-btn")
      .forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const id = parseInt(e.currentTarget.dataset.id);
          const newStatus = e.currentTarget.dataset.status;
          await changeCampaignStatus(id, newStatus);
          closeDetailModal();
        });
      });
  }

  // Formatea una fecha de YYYY-MM-DD a DD/MM/YYYY
  function formatDate(dateString) {
    const [year, month, day] = dateString.split("-");
    return `${day}/${month}/${year}`;
  }

  // Genera nombre de archivo para descargas
  function getImageFileName(cityName, duplaIndex) {
    const suffix = duplaIndex === 0 ? "1" : "5";
    return `${cityName}${suffix}`;
  }

  // Escapa caracteres especiales de HTML
  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>

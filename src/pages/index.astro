---
import Layout1 from "../layouts/Layout1.astro";
import Header from "../sections/header.astro";
import AddCity from "../components/create_city.astro";
---

<Layout1 title="Dashboard">
  <Header />
  <AddCity />
  <section id="dashboard" class="flex-row">
    <!-- Las campañas se renderizan dinámicamente aquí -->
  </section>
</Layout1>

<style>
  #dashboard {
    padding: 30px;
    flex-wrap: wrap;
    gap: 20px;
    align-items: flex-start;
  }

  .empty-state {
    width: 100%;
    padding: 60px 20px;
    gap: 15px;
    color: var(--clr-gray);
  }

  .empty-state i {
    font-size: 3rem;
  }

  .empty-state h4 {
    color: var(--clr-text);
  }
</style>

<style is:inline>
  .campaign-card {
    background-color: var(--clr-dark2);
    padding: 15px 15px;
    width: 450px;
    max-width: 100%;
    gap: 5px;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    border: solid 1px var(--clr-border);
    text-align: left;
  }

  .campaign-card .delete-campaign,
  .campaign-card .edit-campaign {
    position: absolute;
    top: 15px;
    right: 15px;
    background: transparent;
    border: none;
    color: var(--clr-gray);
    cursor: pointer;
    font-size: 20px;
    padding: 5px;
    transition: var(--transition);
    border: solid 1px var(--clr-border);
    background-color: var(--clr-dark);
    padding: 7px;
  }

  .campaign-card .edit-campaign {
    right: 53px;
  }

  .campaign-card .delete-campaign:hover,
  .campaign-card .edit-campaign:hover {
    color: var(--clr-main);
  }

  .campaign-header {
    width: 100%;
    gap: 5px;
    padding-bottom: 15px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .campaign-header h5 {
    color: var(--clr-main);
    font-size: 1.1rem;
  }

  .campaign-header p {
    font-size: 0.85rem;
    color: var(--clr-gray);
    display: flex;
    gap: 7px;
  }

  .bloque {
    padding: 12px;
    width: 100%;
    gap: 10px;
    background-color: var(--clr-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bloque > h6 {
    width: 100%;
    color: var(--clr-main);
    font-size: 0.8rem;
    text-align: center;
    margin-bottom: 5px;
    text-align: left;
  }

  .bloque-content {
    width: 100%;
    display: flex;
    flex-direction: row;
    gap: 10px;
  }

  .bloque-item {
    flex: 1;
    border: none;
    background-color: var(--clr-dark);
    padding: 0px;
    gap: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bloque-item img {
    width: 100%;
    height: 192px;
    object-fit: cover;
    border: solid 1px var(--clr-border);
  }

  .bloque-item p {
    width: 100%;
    padding: 8px;
    background-color: var(--clr-dark2);
    border: solid 1px var(--clr-border);
    color: var(--clr-text);
    font-size: 0.85rem;
    line-height: 1.4;
    height: 192px;
    overflow-y: auto;
  }

  .bloque-item button {
    width: 100%;
    font-size: 0.8rem;
    padding: 8px 12px;
    gap: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .bloque-item button i {
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (max-width: 600px) {
    .bloque-content {
      flex-direction: column;
    }

    .campaign-card {
      width: 100%;
    }
  }
</style>

<script>
  //@ts-nocheck

  const $dashboard = document.getElementById("dashboard");

  document.addEventListener("DOMContentLoaded", () => {
    renderCampaigns();
  });

  window.addEventListener("campaignAdded", () => {
    renderCampaigns();
  });

  function renderCampaigns() {
    const campaigns = JSON.parse(localStorage.getItem("campaigns") || "[]");

    if (campaigns.length === 0) {
      $dashboard.innerHTML = `
        <div class="empty-state flex-column">
          <i class="bi bi-inbox"></i>
          <h4>No hay campañas aún</h4>
          <p>Haz clic en el botón + para crear tu primera campaña</p>
        </div>
      `;
      return;
    }

    $dashboard.innerHTML = campaigns
      .map(
        (campaign) => `
      <div class="campaign-card" data-id="${campaign.id}">
        <i class="bi bi-pencil-square edit-campaign" data-id="${campaign.id}"></i>
        <i class="bi bi-trash delete-campaign" data-id="${campaign.id}"></i>
        
        <div class="campaign-header">
          <h5>${campaign.cityName.toUpperCase()}</h5>
          <p><i class="bi bi-calendar3"></i> ${formatDate(campaign.startDate)}</p>
        </div>

        ${campaign.duplas
          .map(
            (dupla, index) => `
          <div class="bloque">
            <h6>DUPLA #${index + 1}: ${dupla.name}</h6>
            
            <div class="bloque-content">
              <div class="bloque-item">
                <img src="${dupla.image}" alt="Imagen ${dupla.name}" />
                <button class="boton download-img" data-img="${dupla.image}" data-name="${campaign.cityName}_${dupla.name}_img">
                  <i class="bi bi-download"></i>
                </button>
              </div>

              <div class="bloque-item">
                <p>${escapeHtml(dupla.text)}</p>
                <button class="boton copy-text" data-text="${escapeHtml(dupla.text)}">
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
            </div>
          </div>
        `,
          )
          .join("")}
      </div>
    `,
      )
      .join("");

    addEventListeners();
  }

  function addEventListeners() {
    document.querySelectorAll(".copy-text").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const text = e.currentTarget.dataset.text;
        navigator.clipboard.writeText(text).then(() => {
          const originalText = e.currentTarget.innerHTML;
          e.currentTarget.innerHTML = '<i class="bi bi-check"></i> Copiado!';
          setTimeout(() => {
            e.currentTarget.innerHTML = originalText;
          }, 1500);
        });
      });
    });

    document.querySelectorAll(".download-img").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const imgData = e.currentTarget.dataset.img;
        const fileName = e.currentTarget.dataset.name;
        downloadImage(imgData, fileName);
      });
    });

    document.querySelectorAll(".delete-campaign").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const id = parseInt(e.currentTarget.dataset.id);
        if (confirm("¿Estás seguro de eliminar esta campaña?")) {
          deleteCampaign(id);
        }
      });
    });
  }

  function downloadImage(dataUrl, fileName) {
    const link = document.createElement("a");
    link.href = dataUrl;
    link.download = `${fileName}.png`;
    link.click();
  }

  function deleteCampaign(id) {
    let campaigns = JSON.parse(localStorage.getItem("campaigns") || "[]");
    campaigns = campaigns.filter((c) => c.id !== id);
    localStorage.setItem("campaigns", JSON.stringify(campaigns));
    renderCampaigns();
  }

  function formatDate(dateString) {
    const date = new Date(dateString + "T00:00:00");
    return date.toLocaleDateString("es-ES", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  }

  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>
